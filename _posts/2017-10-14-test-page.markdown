---
layout: post
title:  "История создания анонимного Telegram-бота: от идеи до реализации"
---
![It's time for awesome stories]({{ "/assets/time_for_stories.jpg" }})

Мой первый пост будет о создании Telegram-бота для отправки анонимных сообщений в групповые чаты - [@BotBoobot](https://t.me/botboobot). Здесь не будет кода, только история создания, проблемы, с которыми столкнулся при создании. То, что тут написано применимо к любым платформам, т.е. логика работы бота легко переносится на другие платформы (ВК например).

Как родилась сама идея уже не помню. Естественно такая возможность могла быть реалиизована только с помощью ботов. На тот момент Телеграм-боты уже были популярны, каждый кому не лень создавал своих.

Гугление показало, что есть лишь боты с помощью, которых создаются псевдо_групповые_чаты, где каждому пользователю выдается случайный никнейм, или же анонимные тет-а-тет чаты. Нет, так не интересно. Гораздо прикольней было бы потроллить пользователей в уже созданном чате, отправляя сообщения от имени бота. Интуиция подсказывала, что создание такого бота реально=) Прежде чем проверить гипотезу я решил попробовать создать helloworld-бота, посмотреть что вообще боты умеют. Благо статей в интернете было много. Если кому интересно, тестового бота делал по [этой](http://abdulmadzhidov.ru/blog/Telegram-bot-in-30-min) статье. Итак, базовые возможности ботов изучены, пора подумать, что понадобиться для создания анонимного бота.

Ход мыслей был примерно следующий. Понятно, что, чтобы отправлять сообщения от имени бота в чат, бот должен быть добавлен в этот чат. Также понятно, что для того чтобы попросить бота отправить сообщение в какой-либо чат, нужно делать это в личке с ботом. Кэп детектед. Самый простой и логичный способ - перед отправкой анонимного сообщения отправлять боту название чата. То есть у бота должна быть база названий чатов, в которые его добавили. 

Первый вопрос, который необходимо было проверить - может ли бот узнавать о названиях чатов, в которые его добавляют? Все подобные вопросы проверял на практике. Telegram шлет ответы боту JSON-объектом. После добавления бота в тестовый чат, в JSON-ответе кроме всего прочего появлялось и название тестового чата с его айдишником. Отлично! Значит каждое такое название + id чата полученное в ответе будем записывать в БД.

ОК, БД будет наполняться чатами. Но что, если в таблице БД будет два чата с одинаковым названием? Скорей всего пользователь состоит в одном из них, так как вероятность того, что пользователь состоит в чатах с одинаковыми названиями, крайне мала. Есть еще одна проблема. Что если пользователь попросит бота отправить сообщение в чат, в котором сам пользователь не состоит, но в БД такой чат есть? Решить эти две проблемы помогла бы возможность узнавать состоит ли пользователь в запрашиваемом чате. В используемой [библиотеке](https://github.com/python-telegram-bot/python-telegram-bot) была найдена подходящая функция.

Оставалось фильтровать слишком длинные сообщения, слишком частые сообщения и SQL-инъекции.

Готово. Работает! Бот был добавлен в несколько интернет-каталогов. Люди начали добавлять в чаты и пользоваться. Основная часть бота была написана в течении недели-двух. Мелкие баги исправлялись еще в течении нескольких месяцев. Также менялись и дополнялись описание бота, хелпы и другие сообщения от бота пользователю.

Неожиданным оказалось то, что бота часто добавляли в каналы. Видимо название оказалось "удачным".

В дальнейшем к боту был прикручен [Botan](http://botan.io) - инструмент аналитики ботов Telegram от Yandex.

Логи и аналитика показывали, что пользователи часто не понимали как пользоваться ботом. Это в какой-то мере моя вина.

Через полгода после запуска бота наконец-то был записан обучающий видео-ролик. После этого количество неправильных команд к боту по отношению к правильным командам немного уменьшилось.

![Yandex appmetrica]({{ "/assets/botan.png" }})

После изучения программирования на [Hexlet](https://goo.gl/nT3npR) (скрытая реклама детектед), стало понятно, что хоть бот и работает, мой код просто ужасен. Его конечно стоит переписать.

Спустя какое-то время обнаружил, похожего бота. Но это уже другая история...
